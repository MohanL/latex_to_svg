function GetWindow(){document=jsdom(),html=document.firstChild,window=document.defaultView,window.console=console,window.addEventListener("error",function(e){AddError("Error: "+e.error.stack)}),content=document.body.appendChild(document.createElement("div")),content.id="MathJax_Content",content.innerHTML="$x$ `x` <math><mi>x</mi></math>","about:blank"===document._URL&&(document._URL="file:///blank.html")}function ConfigureMathJax(){if(window.MathJax={jax:["input/TeX","input/MathML","input/AsciiMath","output/SVG","output/CommonHTML"],extensions:["tex2jax.js","mml2jax.js","asciimath2jax.js","toMathML.js"],TeX:{extensions:window.Array("AMSmath.js","AMSsymbols.js","autoload-all.js")},tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]],preview:"none"},mml2jax:{preview:"none"},asciimath2jax:{preview:"none"},SVG:{useFontCache:!0,useGlobalCache:!1,EqnChunk:1e6,EqnDelay:0},CommonHTML:{EqnChunk:1e6,EqnDelay:0,undefinedFamily:"monospace"},AuthorInit:function(){MathJax=window.MathJax,delete MathJax.Hub.config.styles,MathJax.Hub.Startup.MenuZoom=function(){},MathJax.Extension.MathEvents={Event:{},Touch:{},Hover:{}},MathJax.Ajax.loaded[MathJax.Ajax.fileURL("[MathJax]/extensions/MathEvents.js")]=!0,MathJax.Ajax.timer.create=function(e,t){return e=MathJax.Callback(e),e(this.STATUS.OK),e},MathJax.Message.Set=function(e,t,a){displayMessages&&0!==t&&(e instanceof window.Array&&(e=MathJax.Localization._.apply(MathJax.Localization,e)),console.error(e))},MathJax.Message.Clear=function(){},MathJax.Message.Remove=function(){},MathJax.Message.Init=function(){},MathJax.Hub.Register.MessageHook("Math Processing Error",function(e){AddError("Math Processing Error: "+e[2].message)}),MathJax.Hub.Register.MessageHook("SVG Jax - unknown char",function(e){AddError("SVG - Unknown character: U+"+e[1].toString(16).toUpperCase()+" in "+(e[2].fonts||["unknown"]).join(","),!undefinedChar)}),MathJax.Hub.Register.MessageHook("MathML Jax - unknown node type",function(e){AddError("MathML - Unknown node type: "+e[1])}),MathJax.Hub.Register.MessageHook("MathML Jax - parse error",function(e){AddError("MathML - "+e[1])}),MathJax.Hub.Register.MessageHook("AsciiMath Jax - parse error",function(e){AddError("AsciiMath parse error: "+e[1])}),MathJax.Hub.Register.MessageHook("TeX Jax - parse error",function(e){AddError("TeX parse error: "+e[1])}),MathJax.Hub.Register.MessageHook("file load error",function(e){AddError("File load error: "+e[1])}),MathJax.Hub.processSectionDelay=0,MathJax.Hub.processUpdateTime=1e7,MathJax.Hub.processUpdateDelay=0,MathJax.Hub.Register.StartupHook("SVG Jax Config",function(){var e=MathJax.OutputJax.SVG,t=MathJax.HTML;delete e.config.styles,e.Augment({InitializeSVG:function(){this.defaultEx=6,this.defaultWidth=100},preTranslate:function(a){var r,n,s,i,o,l,h,u,d=a.jax[this.id],c=d.length,m=this.config.linebreaks.automatic,x=this.config.linebreaks.width;for(r=0;r<c;r++)n=d[r],n.parentNode&&(s=n.previousSibling,s&&String(s.className).match(/^MathJax(_SVG)?(_Display)?( MathJax(_SVG)?_Processing)?$/)&&s.parentNode.removeChild(s),l=n.MathJax.elementJax,l&&(l.SVG={display:"block"===l.root.Get("display")},i=o=t.Element("span",{style:{"font-size":this.config.scale+"%",display:"inline-block"},className:"MathJax_SVG",id:l.inputID+"-Frame",isMathJax:!0,jaxID:this.id}),l.SVG.display&&(o=t.Element("div",{className:"MathJax_SVG_Display"}),o.appendChild(i)),o.className+=" MathJax_SVG_Processing",n.parentNode.insertBefore(o,n),l.SVG.ex=h=(data||defaults).ex,l.SVG.em=u=h/e.TeX.x_height*1e3,l.SVG.cwidth=x/u*1e3,l.SVG.lineWidth=m?x/u*1e3:e.BIGDIMEN));a.SVGeqn=a.SVGlast=0,a.SVGi=-1,a.SVGchunk=this.config.EqnChunk,a.SVGdelay=!1}}),e.BBOX.TEXT.Augment({Init:function(t,a,r){r||(r={}),r.stroke="none",""===r["font-style"]&&delete r["font-style"],""===r["font-weight"]&&delete r["font-weight"],this.SUPER(arguments).Init.call(this,r),e.addText(this.element,a);var n={width:8.5*a.length,height:18,y:-12};t*=1e3/e.em,this.element.setAttribute("font-family","monospace"),this.element.setAttribute("transform","scale("+t+") matrix(1 0 0 -1 0 0)"),this.w=this.r=n.width*t,this.l=0,this.h=this.H=-n.y*t,this.d=this.D=(n.height+n.y)*t}})}),MathJax.Hub.Register.StartupHook("CommonHTML Jax Config",function(){var e=MathJax.OutputJax.CommonHTML,t=(MathJax.HTML,e.config.styles);delete t["#MathJax_CHTML_Tooltip"],delete t[".MJXc-processing"],delete t[".MJXc-processed"],delete t[".mjx-chartest"],delete t[".mjx-chartest .mjx-char"],delete t[".mjx-chartest .mjx-box"],delete t[".mjx-test"],delete t[".mjx-ex-boxtest"],e.Augment({webfontDir:fontURL,getDefaultExEm:function(){var t=document.head.getElementsByTagName("style");CHTMLSTYLES=t[t.length-1].innerHTML,this.pxPerInch=96,this.defaultEx=6,this.defaultEm=6/e.TEX.x_height*1e3,this.defaultWidth=100},preTranslate:function(t){var a,r,n,s,i,o,l,h=t.jax[this.id],u=h.length,d=this.config.linebreaks.automatic,c=this.config.linebreaks.width;for(a=0;a<u;a++)if(r=h[a],r.parentNode&&(n=r.previousSibling,n&&n.className&&"mjx-chtml"===String(n.className).substr(0,9)&&n.parentNode.removeChild(n),i=r.MathJax.elementJax)){if(i.CHTML={display:"block"===i.root.Get("display")},s=e.Element("mjx-chtml",{id:i.inputID+"-Frame",isMathJax:!0,jaxID:this.id}),i.CHTML.display){var m=e.Element("mjx-chtml",{className:"MJXc-display",isMathJax:!1});m.appendChild(s),s=m}s.className+=" MJXc-processing",r.parentNode.insertBefore(s,r),i.CHTML.ex=o=(data||defaults).ex,i.CHTML.em=l=o/e.TEX.x_height,i.CHTML.cwidth=c/l,i.CHTML.lineWidth=d?c/l:e.BIGDIMEN,i.CHTML.scale=1,i.CHTML.fontsize="100%"}t.CHTMLeqn=t.CHTMLlast=0,t.CHTMLi=-1,t.CHTMLchunk=this.config.EqnChunk,t.CHTMLdelay=!1},getHDW:function(e,t,a){return{h:.8,d:.2,w:.5*e.length}}})}),MathJax.Hub.Register.StartupHook("End",function(){MathJax.OutputJax.SVG.resetGlyphs(!0),MathJax.ElementJax.mml.ID=0,serverState=STATE.READY,MathJax.Hub.Queue(StartQueue)})}},extensions)for(var e=extensions.split(/s*,\s*/),t=0;t<e.length;t++){var a=e[t].match(/^(.*?)(\.js)?$/);window.MathJax.extensions.push(a[1]+".js")}var r=function(e){for(var t in e)if(e.hasOwnProperty(t))if(e[t]instanceof Array){var a=window.Array();e[t]=a.concat.apply(a,e[t])}else"object"==typeof e[t]&&r(e[t])};MathJaxConfig&&(r(MathJaxConfig),Insert(window.MathJax,MathJaxConfig))}function Insert(e,t){for(var a in t)t.hasOwnProperty(a)&&("object"!=typeof t[a]||t[a]instanceof Array||"object"!=typeof e[a]&&"function"!=typeof e[a]?e[a]=t[a]:Insert(e[a],t[a]));return e}function StartMathJax(){serverState=STATE.STARTED;var e=document.createElement("script");e.src=MathJaxPath,e.onerror=function(){AddError("Can't load MathJax.js from "+MathJaxPath)},document.head.appendChild(e)}function ReportError(e,t){AddError(e),(t||callback)({errors:errors})}function AddError(e,t){displayErrors&&console.error(e),t||errors.push(e)}function GetMML(e){if(data.mml||data.speakText){var t=MathJax.Hub.getAllJax()[0];try{e.mml=t.root.toMathML("",t)}catch(t){if(!t.restart)throw t;return MathJax.Callback.After(window.Array(GetMML,e),t.restart)}}}function GetSpeech(e){if(data.speakText)if(speech.setupEngine({semantics:!0,domain:data.speakRuleset,style:data.speakStyle}),e.speakText=speech.processExpression(e.mml),data.mml){var t=MathJax.Hub.getAllJax()[0];t.root.alttext=e.speakText,t.root.attrNames&&t.root.attrNames.push("alttext"),e.mml=t.root.toMathML("",t)}else delete e.mml}function GetHTML(e){if(data.html){var t=MathJax.Hub.getAllJax()[0];if(t){var a=t.SourceElement(),r=a.previousSibling;e.html=r.outerHTML,data.css&&(e.css=CHTMLSTYLES)}}}function GetSVG(e){if(data.svg||data.png||data.img){var t=MathJax.Hub.getAllJax()[0];if(t){var a=t.SourceElement(),r=a.previousSibling.getElementsByTagName("svg")[0];if(r.setAttribute("xmlns","http://www.w3.org/2000/svg"),data.speakText){ID++;var n="MathJax-SVG-"+ID;r.setAttribute("role","math"),r.setAttribute("aria-labelledby",n+"-Title "+n+"-Desc");for(var s=0,i=r.childNodes.length;s<i;s++)r.childNodes[s].setAttribute("aria-hidden",!0);var o=MathJax.HTML.Element("desc",{id:n+"-Desc"},[e.speakText]);r.insertBefore(o,r.firstChild),o=MathJax.HTML.Element("title",{id:n+"-Title"},["Equation"]),r.insertBefore(o,r.firstChild)}var l=r.outerHTML.replace(/><([^\/])/g,">\n<$1").replace(/(<\/[a-z]*>)(?=<\/)/g,"$1\n").replace(/(<use [^>]*)(href=)/g," $1xlink:$2"),h=['<?xml version="1.0" standalone="no"?>','<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">',l].join("\n");data.svg&&(e.svg=l),data.png&&(e.svgfile=h),data.img&&(data.svg&&(e.svg=h),e.img=['<img src="file.svg" style="',r.style.cssText," width:",r.getAttribute("width"),"; height:",r.getAttribute("height"),';"',data.speakText?' alt="'+e.speakText+'"':""," />"].join(""))}}}function GetPNG(e){var t=e.svgfile;if(delete e.svgfile,data.png){var a=["-jar",BatikRasterizerPath,"-dpi",data.dpi,tmpfile+".svg"],r=MathJax.Callback(function(){}),n=function(e){if(e)return AddError(e.message),r(),!0},s=tmpfile+".svg",i=tmpfile+".png";return fs.writeFile(s,t,function(t){n(t)||execFile("java",a,function(t,a,o){return n(t)?void fs.unlinkSync(s):void fs.readFile(i,null,function(t,a){e.png="data:image/png;base64,"+(a||"").toString("base64"),fs.unlinkSync(s),fs.unlinkSync(i),n(t),r()})})}),r}}function StartQueue(){if(data=callback=null,errors=[],queue.length){serverState=STATE.BUSY;var e={},t=window.Array,a=queue.shift();data=a[0],callback=a[1];var r=delimiters[data.format],n=data.math;"MathML"!==data.format&&(n=n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")),content.innerHTML=r[0]+n+r[1],html.setAttribute("xmlns:"+data.xmlns,"http://www.w3.org/1998/Math/MathML");var s=MathJax.OutputJax.CommonHTML,i=MathJax.OutputJax.SVG,o=MathJax.InputJax.TeX,l=MathJax.Hub;i.defaultEx=s.defaultEx=data.ex,i.defaultWidth=CHTMLdefaultWidth=data.width*data.ex,i.config.linebreaks.automatic=s.config.linebreaks.automatic=data.linebreaks,i.config.linebreaks.width=s.config.linebreaks.width=data.width*data.ex,i.config.useFontCache=data.useFontCache,i.config.useGlobalCache=data.useGlobalCache,o.config.equationNumbers.autoNumber=data.equationNumbers,GetState(data.state);var h=data.html?"CommonHTML":"SVG";timer=setTimeout(RestartMathJax,data.timeout),l.Queue(t(SetRenderer,h),t("Typeset",l),t(TypesetDone,e),t(GetMML,e),t(GetSpeech,e),t(GetHTML,e),t(RerenderSVG,e),t(GetSVG,e),t(GetPNG,e),t(ReturnResult,e))}}function GetState(e){var t=MathJax.OutputJax.SVG,a=MathJax.InputJax.TeX,r=MathJax.ElementJax.mml,n=MathJax.Extension["TeX/AMSmath"],s=(MathJax.Hub,MathJax.HTML),i=t.BBOX.GLYPH;e&&e.AMS?(n.startNumber=e.AMS.startNumber,n.labels=e.AMS.labels,n.IDs=e.AMS.IDs,r.SUPER.ID=e.mmlID,i.glyphs=e.glyphs,i.defs=e.defs,i.n=e.n,ID=e.ID):(e&&(e.AMS={}),t.resetGlyphs(!0),data.useGlobalCache&&(e.glyphs={},e.defs=s.Element("defs"),e.n=0),a.resetEquationNumbers&&a.resetEquationNumbers(),r.SUPER.ID=ID=0)}function TypesetDone(e){timer&&(clearTimeout(timer),timer=null),html.removeAttribute("xmlns:"+data.xmlns);var t=data.state;if(t){var a=MathJax.Extension["TeX/AMSmath"],r=MathJax.OutputJax.SVG.BBOX.GLYPH;t.AMS.startNumber=a.startNumber,t.AMS.labels=a.labels,t.AMS.IDs=a.IDs,t.mmlID=MathJax.ElementJax.mml.SUPER.ID,t.glyphs=r.glyphs,t.defs=r.defs,t.n=r.n,t.ID=ID}}function ReturnResult(e){errors.length&&(e.errors=errors),callback(e),serverState=STATE.READY,StartQueue()}function SetRenderer(e){return MathJax.Hub.setRenderer(e)}function RerenderSVG(e){if(data.html&&(data.svg||data.png||data.img)){timer=setTimeout(RestartMathJax,data.timeout);var t=MathJax.Callback.Queue(),a=window.Array;return t.Push(a(SetRenderer,"SVG"),a("Rerender",MathJax.Hub),a(TypesetDone,e))}}function RestartMathJax(){timer&&(MathJax.Hub.queue.queue=[],MathJax=timer=window=document=html=content=null,ReportError("Timeout waiting for MathJax:  restarting"),serverState=STATE.STOPPED),GetWindow(),ConfigureMathJax(),StartMathJax()}var http=require("http"),fs=require("fs"),path=require("path"),url=require("url"),fmt=require("util").format,jsdom=require("jsdom").jsdom,execFile=require("child_process").execFile,speech=require("speech-rule-engine"),os=require("os");require("./patch/jsdom.js").patch(jsdom);var displayMessages=!1,displayErrors=!0,undefinedChar=!1,extensions="",fontURL="https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS",defaults={ex:6,width:100,useFontCache:!0,useGlobalCache:!1,linebreaks:!1,equationNumbers:"none",math:"",format:"TeX",xmlns:"mml",html:!1,css:!1,mml:!1,svg:!1,img:!1,png:!1,dpi:144,speakText:!1,speakRuleset:"mathspeak",speakStyle:"default",timeout:1e4},STATE={STOPPED:1,STARTED:2,READY:3,BUSY:4},MathJaxPath=url.resolve("file:///","file:"+require.resolve("mathjax/unpacked/MathJax")),BatikRasterizerPath=path.resolve(__dirname,"..","batik/batik-rasterizer.jar"),MathJaxConfig,MathJax,serverState=STATE.STOPPED,timer,tmpfile=os.tmpdir()+"/mj-single-svg"+process.pid,document,window,content,html,queue=[],data,callback,errors=[],ID=0,delimiters={TeX:["$$","$$"],"inline-TeX":["$","$"],AsciiMath:["`","`"],MathML:["",""]},CHTMLSTYLES;exports.typeset=function(e,t){if(!t||"function"!=typeof t)return void(displayErrors&&console.error("Missing callback"));var a={};for(var r in defaults)defaults.hasOwnProperty(r)&&(a[r]=e.hasOwnProperty(r)?e[r]:defaults[r]);return e.state&&(a.state=e.state),delimiters[a.format]?(queue.push([a,t]),serverState==STATE.STOPPED&&RestartMathJax(),void(serverState==STATE.READY&&StartQueue())):void ReportError("Unknown format: "+a.format,t)},exports.start=function(){RestartMathJax()},exports.config=function(e){null!=e.displayMessages&&(displayMessages=e.displayMessages),null!=e.displayErrors&&(displayErrors=e.displayErrors),null!=e.undefinedCharError&&(undefinedChar=e.undefinedCharError),null!=e.extensions&&(extensions=e.extensions),null!=e.fontURL&&(fontURL=e.fontURL),e.MathJax&&(MathJaxConfig=e.MathJax)};